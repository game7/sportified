- javascript("jquery-ui.min.js")
- javascript("wymeditor/jquery.wymeditor")
:javascript
  $(function() {
    $("#toggle_layout").click(function(){
      if ($(this).text() == 'Hide') {
        $('.layout').addClass('no-border');
        $('.layout-holder').addClass('no-border');
        $('.layout-panel').addClass('no-border');
        $(this).text('Show');
      } else {
        $('.layout').removeClass('no-border');
        $('.layout-holder').removeClass('no-border');
        $('.layout-panel').removeClass('no-border');
        $(this).text('Hide');
      }
      return false;      
    });
    $("#toggle_editor").click(function(){
      if ($(this).text() == 'Hide') {
        $('.layout-panel .block-frame').addClass('no-border');
        $('.layout-panel .block-chrome').addClass('hidden');
        $(this).text('Show');
      } else {
        $('.layout-panel .block-frame').removeClass('no-border');
        $('.layout-panel .block-chrome').removeClass('hidden');
        $(this).text('Hide');
      }
      return false;      
    });
    $("#toggle_content").click(function(){
       if ($(this).text() == 'Hide') {
        $('.layout-panel .block-content').addClass('hidden');
        $(this).text('Show');
      } else {
        $('.layout-panel .block-content').removeClass('hidden');
        $(this).text('Hide');
      }
      return false;       
    });
    $("#toggle_edit").click(function(){
      if ($(this).text() == 'Preview') {
        $('.layout').addClass('preview');
        $('.layout-holder').addClass('preview');
        $('.layout-panel').addClass('preview');
        $('.layout-panel .block-frame').addClass('preview');
        $('.layout-panel .block-chrome').addClass('preview');
        $(this).text('Edit');
      } else {
        $('.layout').removeClass('preview');
        $('.layout-holder').removeClass('preview');
        $('.layout-panel').removeClass('preview');
        $('.layout-panel .block-frame').removeClass('preview');
        $('.layout-panel .block-chrome').removeClass('preview');
        $(this).text('Preview');
      }
      return false;
    });
    $("#catalog > .item").draggable({
      revert: "invalid",
      helper: "clone",
      opacity: 0.7,
      connectToSortable: ".layout-panel"        
    });
    $(".layout-panel").sortable({
      revert: "true",
      handle: ".block-chrome",
      opacity: 0.7,
      connectWith: $('.layout-panel'),
      placeholder: "ui-state-highlight",
      update: function( event, ui ) {
        temp_id = ui.item.attr('id');
        var items = $(this).sortable('toArray');
        /* if subject is a new item */
        if(temp_id.indexOf('new_block') == 0) {
          panel = $('#' + this.id).closest('.layout-panel');
          panel_id = panel.attr('id').replace('panel_','');
          layout_id = panel.closest('.layout').attr('id').replace('layout_','');
          ui.item.attr('id', 'create_block')
          $.ajax({
            type: 'post',
            data: 'temp_id=create_block&block_type='+ui.item.attr("block") + '&position='+items.indexOf(temp_id) + '&layout_id='+layout_id + '&panel_id='+panel_id,
            dataType: 'script',
            async: false,
            success: function(msg){
              /*$('#' + temp_id).attr('id', 'block_'+msg['_id']);*/
            },
            url: '#{page_blocks_path(@page)}'
          });
        }
        /* if items to update position */
        if(items.length > 0) {
          layout_id = $('#' + items[0]).closest('.layout').attr('id').replace('layout_','');
          panel_id = $('#' + items[0]).closest('.layout-panel').attr('id').replace('panel_','');
          $.ajax({
            type: 'post',
            data: $(this).sortable('serialize') + '&layout_id='+layout_id + '&panel_id='+panel_id,
            dataType: 'json',
            success: function(msg){
              alert('done');
            },
            url: '#{position_page_blocks_path(@page)}'
          }); 
        } 
      }   
    });
  });



- content_for :sidebar do
  = render 'shared/page_options'
  %p
    %strong Layout: 
    %a#toggle_layout{ :href => '#' } Hide
    %br/
    %strong Editor: 
    %a#toggle_editor{ :href => '#' } Hide
    %br/
    %strong Content: 
    %a#toggle_content{ :href => '#' } Hide
  %p #{ link_to 'Go to page', page_friendly_path(@page.path) }
  %strong Add Content
  (Drag & Drop)
  #catalog
    .item.frame{ :id => "new_block_#{BSON::ObjectId.new}", :block => 'TextBlock' }
      .chrome Text
    .item.frame{ :id => "new_block_#{BSON::ObjectId.new}", :block => 'DividerBlock' }
      .chrome Divider
    .item.frame{ :id => "new_block_#{BSON::ObjectId.new}", :block => 'ContactBlock' }
      .chrome Contact
    .item.frame{ :id => "new_block_#{BSON::ObjectId.new}", :block => 'DocumentBlock' }
      .chrome Document
    .item.frame{ :id => "new_block_#{BSON::ObjectId.new}", :block => 'ImageBlock' }
      .chrome Image

%h1 #{ @page.title }
.blocks
  = render :partial => 'layouts/default', :locals => { :height => 100, :blocks => @blocks_for_panel[:default], :edit => true }
  - @page.layouts.asc(:position).each do |layout|
    = render :partial => 'layouts/wireframe', :locals => { :layout => layout, :height => 100, :blocks => @blocks_for_panel, :edit => true }
.clear

#dialog-modal

:css
  .layout { margin-bottom: 4px; padding: 2px; border: 1px solid gray; }
  .layout.preview { border: none; }
  .layout-panel { float: left; border: 1px dashed gray; margin: -1px; }
  //.layout-panel.hidden { border: none; }
  .layout-holder { float: left; border: 1px dashed gray; margin: -1px; }
  //.layout-holder.hidden { border: none; }
  .block { margin: 5px;}
  .block-frame { border: 1px solid gray; }
  //.block-frame.hidden { border: none; }
  .block-chrome { padding: 5px; background-color: gray; }
  //.block-chrome.hidden { display: none; }
  .block-name { float: left; }
  .block-functions { float: right; }
  .block-content { padding: 3px; }
  //.block-content.hidden { display: none; }
  .ui-state-highlight { height: 1.5em; line-height: 1.2em; }
  .no-border { border: none; }

